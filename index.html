<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apartment Reservation System</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Семейный квартал - система резервации</h1>
    <p>Территория счастья</p>

    <div id="blocks"></div>

    <!-- Modal -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="apt-title"></h2>
        <div id="status"></div>
        <div id="form-container" style="display:none;">
          <input type="text" id="surname" placeholder="Фамилия" required>
          <input type="text" id="name" placeholder="Имя" required>
          <button id="reserve-btn">Зарезервировать</button>
        </div>
        <button id="cancel-btn" style="display:none; background:#e74c3c;">Отмена резерва</button>
      </div>
    </div>
  </div>

<script>
  const modal = document.getElementById('modal');
  const closeBtn = document.querySelector('.close');
  let currentApartmentId = null;

  closeBtn.onclick = () => modal.style.display = 'none';
  window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; }

  async function loadApartments() {
    const res = await fetch('/api/apartments');
    const apartments = await res.json();

    const container = document.getElementById('blocks');
    container.innerHTML = '';

    // Group by house_num > block > floor > apartments
    const houses = {};
    apartments.forEach(apt => {
      const house = apt.house_num.toString(); // Treat REAL as string for keys
      if (!houses[house]) houses[house] = {};
      if (!houses[house][apt.block]) houses[house][apt.block] = {};
      if (!houses[house][apt.block][apt.floor]) houses[house][apt.block][apt.floor] = [];
      houses[house][apt.block][apt.floor].push(apt);
    });

    // Render each house (sorted ascending)
    Object.keys(houses).sort().forEach(house => {
      const houseDiv = document.createElement('div');
      houseDiv.className = 'house';
      houseDiv.innerHTML = `<h1>Дом ${house}</h1>`;

      // Render blocks inside house (sorted ascending)
      Object.keys(houses[house]).sort((a, b) => a - b).forEach(block => {
        const blockDiv = document.createElement('div');
        blockDiv.className = 'block';
        blockDiv.innerHTML = `<h2>Подъезд ${block}</h2>`;

        // Get floors, sort descending
        const floors = Object.keys(houses[house][block]).map(Number).sort((a, b) => a - b);

        floors.forEach(floor => {
          const floorDiv = document.createElement('div');
          floorDiv.className = 'floor';
          floorDiv.innerHTML = `<strong>Этаж ${floor}</strong><div class="apartments"></div>`;
          const aptContainer = floorDiv.querySelector('.apartments');

          // Sort apartments by number
          const aptsOnFloor = houses[house][block][floor].sort((a, b) => a.number - b.number);

          aptsOnFloor.forEach(apt => {
            const aptDiv = document.createElement('div');
            aptDiv.className = 'apartment';
            aptDiv.innerHTML = `<strong>${apt.number}</strong><br>${apt.area_nbalc} m²`;  // Add area_nbalc here

            if (apt.name) {
              aptDiv.classList.add('reserved');
              aptDiv.title = `Reserved by ${apt.name} ${apt.surname} (${apt.area_nbalc} m²)`;
            } else {
              aptDiv.title = `Available (${apt.area_nbalc} m²) – click to reserve`;
            }

            aptDiv.onclick = () => openModal(apt);
            aptContainer.appendChild(aptDiv);
          });

          blockDiv.appendChild(floorDiv);
        });

        houseDiv.appendChild(blockDiv);
      });

      container.appendChild(houseDiv);
    });
  }

  function openModal(apt) {
    if (!apt.id) {
      return alert('Ошибка. Свяжитесь с админом.');
    }
    currentApartmentId = apt.id;
    document.getElementById('apt-title').textContent = `${apt.number} (House ${apt.house_num}, Block ${apt.block}, Floor ${apt.floor})`;

    const status = document.getElementById('status');
    const form = document.getElementById('form-container');
    const cancelBtn = document.getElementById('cancel-btn');

    if (apt.name) {
      status.innerHTML = `<p><strong>Reserved by:</strong> ${apt.name} ${apt.surname}</p>`;
      form.style.display = 'none';
      cancelBtn.style.display = 'block';
    } else {
      status.innerHTML = '<p style="color:green;">Available</p>';
      form.style.display = 'block';
      cancelBtn.style.display = 'none';
    }

    modal.style.display = 'block';
  }

  document.getElementById('reserve-btn').onclick = async () => {
    const name = document.getElementById('name').value.trim();
    const surname = document.getElementById('surname').value.trim();
    if (!name || !surname) return alert("Заполните поля");

    await fetch(`/api/reserve/${currentApartmentId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, surname })
    });
    modal.style.display = 'none';
    loadApartments();
  };

  document.getElementById('cancel-btn').onclick = async () => {
    if (!confirm("Cancel this reservation?")) return;

    await fetch(`/api/reserve/${currentApartmentId}`, { method: 'DELETE' });
    modal.style.display = 'none';
    loadApartments();
  };

  // Load on start
  loadApartments();
  setInterval(loadApartments, 10000); // Auto-refresh every 10s
</script>
</body>
</html>